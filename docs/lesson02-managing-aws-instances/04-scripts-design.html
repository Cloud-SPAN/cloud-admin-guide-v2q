<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Automated Management of AWS Instances - The Scripts Design</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../docs/lesson02-managing-aws-instances/03-ami-management.html" rel="prev">
<link href="../../images/cloud-span-icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/cloud-span-icon.png" alt="Cloud-SPAN logo." class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/miscellanea/precourse-instructions.html"> 
<span class="menu-text">Precourse Instructions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/miscellanea/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../docs/lesson02-managing-aws-instances/index.html">Managing AWS Instances</a></li><li class="breadcrumb-item"><a href="../../docs/lesson02-managing-aws-instances/04-scripts-design.html">The Scripts Design</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/lesson01-setting-work-envs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setting Up Cloud/Terminal Environments</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson01-setting-work-envs/01-create-aws-account.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Your AWS Account</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson01-setting-work-envs/02-configure-account.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configure Your AWS Account</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson01-setting-work-envs/03-configure-terminal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configure Your Terminal Environment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson01-setting-work-envs/04-configure-cloudshell.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configure Your AWS CloudShell Environment</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/lesson02-managing-aws-instances/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Managing AWS Instances</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson02-managing-aws-instances/01-configure-instances-internet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configure Instances Internet Access</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson02-managing-aws-instances/02-instances-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instances Management Tasks Using the Scripts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson02-managing-aws-instances/03-ami-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AMIs Management</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/lesson02-managing-aws-instances/04-scripts-design.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">The Scripts Design</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#the-scripts-design" id="toc-the-scripts-design" class="nav-link" data-scroll-target="#the-scripts-design">1. The Scripts Design</a>
  <ul class="collapse">
  <li><a href="#organisation-into-modules" id="toc-organisation-into-modules" class="nav-link" data-scroll-target="#organisation-into-modules">Organisation into modules</a></li>
  <li><a href="#the-aws_.sh-scripts-main-processing-steps" id="toc-the-aws_.sh-scripts-main-processing-steps" class="nav-link" data-scroll-target="#the-aws_.sh-scripts-main-processing-steps">The <code>aws_*.sh</code> scripts main processing steps</a></li>
  <li><a href="#the-scripts-shared-data-communication" id="toc-the-scripts-shared-data-communication" class="nav-link" data-scroll-target="#the-scripts-shared-data-communication">The Scripts “shared data” communication</a>
  <ul class="collapse">
  <li><a href="#getting-the-path-of-the-inputs-and-outputs-directories" id="toc-getting-the-path-of-the-inputs-and-outputs-directories" class="nav-link" data-scroll-target="#getting-the-path-of-the-inputs-and-outputs-directories">Getting the path of the <code>inputs</code> and <code>outputs</code> directories</a></li>
  <li><a href="#making-the-path-of-the-outputsresults-directory" id="toc-making-the-path-of-the-outputsresults-directory" class="nav-link" data-scroll-target="#making-the-path-of-the-outputsresults-directory">Making the path of the <code>outputs</code>/“results” directory</a></li>
  <li><a href="#getting-the-shared-data-in-the-files-tags.txt-and-resourcesids.txt" id="toc-getting-the-shared-data-in-the-files-tags.txt-and-resourcesids.txt" class="nav-link" data-scroll-target="#getting-the-shared-data-in-the-files-tags.txt-and-resourcesids.txt">Getting the “shared data” in the files <code>tags.txt</code> and <code>resourcesIDs.txt</code></a></li>
  </ul></li>
  <li><a href="#the-scripts-loop-through-instances-names" id="toc-the-scripts-loop-through-instances-names" class="nav-link" data-scroll-target="#the-scripts-loop-through-instances-names">The Scripts <strong>loop</strong> through instances names</a>
  <ul class="collapse">
  <li><a href="#the-loops-in-the-other-scripts" id="toc-the-loops-in-the-other-scripts" class="nav-link" data-scroll-target="#the-loops-in-the-other-scripts">The loops in the other scripts</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#the-aws-cli-command-reference" id="toc-the-aws-cli-command-reference" class="nav-link" data-scroll-target="#the-aws-cli-command-reference">2. The AWS CLI Command Reference</a></li>
  <li><a href="#improving-the-scripts" id="toc-improving-the-scripts" class="nav-link" data-scroll-target="#improving-the-scripts">3. Improving the Scripts</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Cloud-SPAN/nerc-metagenomics-v2q/edit/main/docs/lesson02-managing-aws-instances/04-scripts-design.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/Cloud-SPAN/nerc-metagenomics-v2q/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../docs/lesson02-managing-aws-instances/index.html">Managing AWS Instances</a></li><li class="breadcrumb-item"><a href="../../docs/lesson02-managing-aws-instances/04-scripts-design.html">The Scripts Design</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">The Scripts Design</h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>This episode has no hands-on activities but you should have covered the two previous episodes, <a href="./02-instances-management">Instances Management Tasks Using the Scripts</a> and <a href="./03-ami-management">AMIs Management</a>, to better understand the concepts presented in this episode.</p>
</div>
</div>
<section id="overview" class="level1">
<h1>Overview</h1>
<ol type="1">
<li><strong>The Scripts Design</strong><br>
How the Scripts are organised and how they work internally are the subjects of this section.</li>
<li><strong>The AWS CLI Command Reference</strong><br>
The Scripts functionality depends on the AWS CLI commands. This section briefly describes the AWS CLI interface and how we used it to develop the Scripts.</li>
<li><strong>Improving the Scripts</strong><br>
This section describes a few improvements for the Scripts that we may later undertake.</li>
</ol>
</section>
<section id="the-scripts-design" class="level1">
<h1>1. The Scripts Design</h1>
<p>This section describes the organisation and workings of the Scripts. After you read this section, you will know where to look into the Scripts in case you need to improve them.</p>
<p>Let’s recall the Scripts names:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Output</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="Output"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_domainNames_create.sh</span>        aws_instances_configure.sh  csinstances_create.sh</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_domainNames_delete.sh</span>        aws_instances_launch.sh     csinstances_delete.sh</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_allocate.sh</span>       aws_instances_terminate.sh  csinstances_start.sh</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_associate2ins.sh</span>  aws_loginKeyPair_create.sh  csinstances_stop.sh</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_deallocate.sh</span>     aws_loginKeyPair_delete.sh</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_disassociate.sh</span>   colour_utils_functions.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="organisation-into-modules" class="level2">
<h2 class="anchored" data-anchor-id="organisation-into-modules">Organisation into modules</h2>
<p>Recall that you run <code>csinstances_create.sh</code> to create one or multiple <strong>instances</strong> specified in an “<strong><em>instancesNames.txt</em></strong>” file (whose name you can choose), and that each instance is accessed with <code>ssh</code> using a <strong>login key</strong> and a <strong>domain name</strong> that is mapped to an <strong>IP address</strong>.</p>
<p>The main code of <code>csinstances_create.sh</code> is below. <strong>All it does</strong> is to run the <code>aws_*.sh</code> scripts that <em>actually</em> <strong>create</strong> instances and related resources, passing to each such script the parameter it received, the path/name of the “<em>instancesNames.txt</em>” file which, being the first and only parameter you specify, is stored in the script variable <strong><code>$1</code></strong></p>
<p>The script <code>csinstances_delete.sh</code> is organised and works the same way but it runs the scripts that <em>actually</em> <strong>delete</strong> instances and related resources instead.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Output</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="Output"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_loginKeyPair_create.sh</span>      <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_instances_launch.sh</span>         <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_allocate.sh</span>      <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_domainNames_create.sh</span>       <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_elasticIPs_associate2ins.sh</span> <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">aws_instances_configure.sh</span>      <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="kw">||</span> <span class="kw">{</span> <span class="ex">message</span> <span class="st">"</span><span class="va">$error_message</span><span class="st">"</span><span class="kw">;</span> <span class="bu">exit</span> 1<span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span> 0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That all means that each <code>aws_*.sh</code> script is in charge of:</p>
<ul>
<li>a <strong>single type</strong> of AWS operation request (either <em>create, allocate, .., deallocate, or delete</em>)</li>
<li>for <strong>one</strong> or <strong>multiple</strong> AWS resources <strong>all of the same type</strong> (either <em>instance, login key, domain name, or IP address</em>).<br>
Each script will make an AWS operation request for each instance name specified in the file “<em>instancesNames.txt</em>”.</li>
</ul>
<p>Such organisation means that <strong>all</strong> login keys are created first, then <strong>all</strong> instances are created, etc. — and vice versa: <strong>all</strong> instances are deleted first, then <strong>all</strong> login keys are deleted, etc.</p>
<p>An alternative way to organise the Scripts would be such that: each instance and its resources (login key, domain name, and IP address) are created first, then a second instance and its resources are created, and so on. But the code gets much more complicated.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Think of that alternative organisation for the Scripts or any other organisation you would like for the Scripts.</p>
<ul>
<li>Is it really more complex?</li>
<li>Why?</li>
<li>How would <code>csinstances_create.sh</code> be organised?</li>
<li>Do we need more or fewer scripts?</li>
</ul>
<p>If you thought of another alternative organisation, what is the main flow in creating instances and their resources?</p>
</div>
</div>
</section>
<section id="the-aws_.sh-scripts-main-processing-steps" class="level2">
<h2 class="anchored" data-anchor-id="the-aws_.sh-scripts-main-processing-steps">The <code>aws_*.sh</code> scripts main processing steps</h2>
<p>Each <code>aws_*.sh</code> script makes an AWS operation request for each instance name specified in the file “<em>instancesNames.txt</em>” through these main steps:</p>
<ol type="1">
<li><p>Determine the location of relevant “shared data” from the path of the file “<em>instancesNames.txt</em> (received as parameter):</p>
<ul>
<li>the path of the configuration files <code>resourcesIDs.txt</code>, <code>tags.txt</code> — required by the scripts that <strong>create</strong> instances and related resources.</li>
<li>the path of results files (in the <code>outputs</code> directory) that contain the AWS resources IDs — required by the scripts that <strong>delete</strong> instances and related resources, and <code>csinstances_stop.sh</code> and <code>csinstances_start.sh</code>.</li>
</ul></li>
<li><p>makes a list of instances names from the names specified in the file “<em>instancesNames.txt</em>”.</p></li>
<li><p>loop through the instances names list to request, for each instance, the script-relevant AWS operation through running <code>aws</code> passing required parameters — some extracted from the files in step 1.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>The code structure of <code>csinstances_stop.sh</code> and <code>csinstances_start.sh</code> is similar to that to the code structure of the <code>aws_*.sh</code> scripts.</p>
<p>Can you figure out the reason for that (before looking at the code)?</p>
</div>
</div>
</section>
<section id="the-scripts-shared-data-communication" class="level2">
<h2 class="anchored" data-anchor-id="the-scripts-shared-data-communication">The Scripts “shared data” communication</h2>
<p>Breaking down the functionality of the Scripts as described above, or of any software system for that matter, involves designing communication between the parts. Such communication can be based either on <strong>message passing</strong> or <strong>shared data</strong>. Message passing is <strong>explicit</strong> communication between two or more specific parts. Shared data is <strong>implicit</strong> communication: all parts know where the shared data is.</p>
<p>The Scripts use both types of communication:</p>
<ul>
<li><em>message passing</em> is used when passing the name of an “<em>instancesNames.txt</em>” file to and between the Scripts.</li>
<li><em>shared data</em> is used when accessing data in the files in the <code>inputs</code> and <code>outputs</code> directories of a course — which is possible through using specific names and locations for those files which, in turn, makes it possible to determine their path from the path of the “<em>instancesNames.txt</em>” file.</li>
</ul>
<section id="getting-the-path-of-the-inputs-and-outputs-directories" class="level3">
<h3 class="anchored" data-anchor-id="getting-the-path-of-the-inputs-and-outputs-directories">Getting the path of the <code>inputs</code> and <code>outputs</code> directories</h3>
<p>All the <code>aws_*.sh</code> scripts get the path to the shared directories <code>inputs</code> and <code>outputs</code> thus:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">instancesNamesFile</span><span class="op">=</span><span class="va">${1}</span>               <span class="co"># $1 or ${1} is the path of "instancesNames.txt" received as parameter</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">inputsDir</span><span class="op">=</span><span class="va">${1</span><span class="op">%</span>/<span class="pp">*</span><span class="va">}</span>                     <span class="co"># inputs directory path</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDir</span><span class="op">=</span><span class="va">${1</span><span class="op">%</span>/inputs<span class="pp">*</span><span class="va">}</span>/outputs      <span class="co"># outputs directory path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="making-the-path-of-the-outputsresults-directory" class="level3">
<h3 class="anchored" data-anchor-id="making-the-path-of-the-outputsresults-directory">Making the path of the <code>outputs</code>/“results” directory</h3>
<p>Then, each <code>aws_*.sh</code> script that <strong>creates</strong> instances or related resources will use only one of the assignment statements below to make the path of the directory where it will create a file to write the results of each AWS operation request that it will issue for each instance name specified in the file “<em>instancesNames.txt</em>”:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/login-keys-creation-output</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/instances-creation-output</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/ip-addresses-allocation-output  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/domain-names-creation-output</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/ip-addresses-association-output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each <code>aws_*.sh</code> script that <strong>deletes</strong> instances or related resources will use only one of the assignment statements below, instead:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/ip-addresses-deallocate-output<span class="kw">`</span><span class="fu">date</span> <span class="st">'+%Y%m%d.%H%M%S'</span><span class="kw">`</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/login-keys-delete-output<span class="kw">`</span><span class="fu">date</span> <span class="st">'+%Y%m%d.%H%M%S'</span><span class="kw">`</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/instances-delete-output<span class="kw">`</span><span class="fu">date</span> <span class="st">'+%Y%m%d.%H%M%S'</span><span class="kw">`</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/domain-names-delete-output<span class="kw">`</span><span class="fu">date</span> <span class="st">'+%Y%m%d.%H%M%S'</span><span class="kw">`</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="va">outputsDirThisRun</span><span class="op">=</span><span class="va">${outputsDir}</span>/ip-addresses-disassociate-output<span class="kw">`</span><span class="fu">date</span> <span class="st">'+%Y%m%d.%H%M%S'</span><span class="kw">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will remember that the results of deleting instances and related resources are written to directories whose names are suffixed with the current date and time.</p>
</section>
<section id="getting-the-shared-data-in-the-files-tags.txt-and-resourcesids.txt" class="level3">
<h3 class="anchored" data-anchor-id="getting-the-shared-data-in-the-files-tags.txt-and-resourcesids.txt">Getting the “shared data” in the files <code>tags.txt</code> and <code>resourcesIDs.txt</code></h3>
<p>The scripts <code>aws_elasticIPs_allocate.sh</code>, <code>aws_instances_launch.sh</code> and <code>aws_loginKeyPair_create.sh</code> load the labels in the file <code>inputs/tags.txt</code> into the array <code>tags</code>, and then copy the labels values from the <code>tags</code> array to variables with meaningful names:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">tags</span><span class="op">=</span><span class="va">(</span> <span class="kw">`</span><span class="fu">cat</span> <span class="va">$inputsDir</span>/tags.txt<span class="kw">`</span> <span class="va">)</span>  </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">tag_name_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="va">}</span>           </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="va">tag_group_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">3</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="va">tag_project_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">5</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">tag_status_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">7</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="va">tag_pushedby_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">9</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="va">tag_definedin_value</span><span class="op">=</span><span class="va">${tags</span><span class="op">[</span><span class="dv">11</span><span class="op">]</span><span class="va">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The script <code>aws_instances_launch.sh</code> does similarly to get the resources IDs in the file <code>inputs/resourcesIDs.txt</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">resources</span><span class="op">=</span><span class="va">(</span> <span class="kw">`</span><span class="fu">cat</span> <span class="va">$inputsDir</span>/resourcesIDs.txt<span class="kw">`</span> <span class="va">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="va">resource_image_id</span><span class="op">=</span><span class="va">${resources</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="va">resource_instance_type</span><span class="op">=</span><span class="va">${resources</span><span class="op">[</span><span class="dv">3</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="va">resource_security_group_ids</span><span class="op">=</span><span class="va">${resources</span><span class="op">[</span><span class="dv">5</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="va">resource_subnet_id</span><span class="op">=</span><span class="va">${resources</span><span class="op">[</span><span class="dv">7</span><span class="op">]</span><span class="va">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Only the <code>aws_instances_launch.sh</code> uses the resources IDs.</p>
<p>The <code>aws_*.sh</code> scripts that <strong>delete</strong> instances or related resources don’t need nor use the “shared data” in the files <code>tags.txt</code> and <code>resourcesIDs.txt</code>.</p>
</section>
</section>
<section id="the-scripts-loop-through-instances-names" class="level2">
<h2 class="anchored" data-anchor-id="the-scripts-loop-through-instances-names">The Scripts <strong>loop</strong> through instances names</h2>
<p>Once an <code>aws_*.sh</code> script sets access to “shared data” as described above, the script goes through the <strong>loop</strong> where, for each instance name in the “<em>instancesNames.txt</em>” file, the script invokes the AWS operation request it is in charge of.</p>
<p>The loop of the script <code>aws_instances_launch.sh</code> (which creates one or multiple instances) is shown below. We have added the line numbers on the left for convenience but they don’t correspond to the actual line numbers in the script. Also, we have ommitted the code for Results Handling after the invokation of the AWS operation request with <code>aws</code> — such Results Handling is similar in all the <code>aws_*.sh</code> scripts.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">01</span> instancesNames=<span class="er">(</span> <span class="kw">`</span><span class="fu">cat</span> <span class="va">$instancesNamesFile</span><span class="kw">`</span> <span class="kw">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">02</span> for instance in <span class="va">${instancesNames</span><span class="op">[@]</span><span class="va">}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">03</span> do</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">04</span>   logkeyend=<span class="va">${instance</span><span class="op">%</span>-src<span class="pp">*</span><span class="va">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">05</span>   aws ec2 run-instances <span class="at">--image-id</span> <span class="va">$resource_image_id</span> <span class="at">--instance-type</span> <span class="va">$resource_instance_type</span><span class="dt">\</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>06   <span class="at">--key-name</span> <span class="st">"login-key-</span><span class="va">${logkeyend}</span><span class="st">"</span>  <span class="dt">\</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>07   <span class="at">--security-group-ids</span> <span class="va">$resource_security_group_ids</span> <span class="dt">\</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>08   <span class="at">--subnet-id</span> <span class="va">$resource_subnet_id</span> <span class="at">--tag-specifications</span> <span class="dt">\</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>09   <span class="st">"ResourceType=instance, Tags=[{Key=Name,   Value=</span><span class="va">$instance</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">10                      {Key=name,      Value=</span><span class="va">${instance</span><span class="op">,,</span><span class="va">}</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">11                      {Key=group, Value=</span><span class="va">$tag_group_value</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">12                      {Key=project, Value=</span><span class="va">$tag_project_value</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">13                      {Key=status, Value=</span><span class="va">$tag_status_value</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">14                      {Key=pushed_by, Value=</span><span class="va">$tag_pushedby_value</span><span class="st">}, </span><span class="dt">\</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">15                  {Key=defined_in, Value=</span><span class="va">$tag_definedin_value</span><span class="st">},  </span><span class="dt">\</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">16                ]"</span>  <span class="va">$outputsDirThisRun</span>/<span class="va">$instance</span>.txt 2<span class="kw">&amp;</span><span class="ex">1</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="ex">17</span>   if [ <span class="va">$?</span> <span class="at">-eq</span> 0 ]<span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="ex">18</span>      <span class="co">### aws Results Handling</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ex">19</span>   fi</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="ex">20</span> done</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Line 01: the variable <code>instancesNames</code> is initialised as list of the instances names in the file “<em>instancesNames.txt</em>” file (variable <code>$instancesNamesFile</code>).</p>
<p>Line 02: the loop starts, using the variable <code>instance</code> to store the instance name in turn.</p>
<p>Line 04: <code>logkeyend=${instance%-src*}</code> gets the end, the suffix, of the login key name to pass as parameter to <code>aws</code> (line 06). Each login key name is created with the fixed prefix <code>login-key-</code> concatenated to the instance name (in the <code>instance</code> variable) <strong>without</strong> the instance name suffix that identifies the source (<code>%-src*</code>) AMI template (discussed in episode 3).</p>
<p>Lines 05-16 is a single command — the character <code>\</code>, at the end of lines 05-12, tells Bash to carry on reading input before running the command. The command runs the AWS CLI program <code>aws</code> requesting to launch and instance, passing various parameters including: <code>--image-id</code> (AMI id), .. and the tag values (previously loaded from the file <code>inputs/tags.txt</code>). The parameters to <code>aws</code> are discussed below.</p>
<p>Line 16: the results of invoking <code>aws</code> are stored in the file whose name is specified by the value in the variables <code>$outputsDirThisRun/$instance.txt</code> which were previously defined before and within the loop, respectively. Both results (1) and any errors (2), if any, are written to that file (<code>2&amp;1</code>).</p>
<section id="the-loops-in-the-other-scripts" class="level3">
<h3 class="anchored" data-anchor-id="the-loops-in-the-other-scripts">The loops in the other scripts</h3>
<p>The loop in each of all other <code>aws_*.sh</code> scripts is similar to the loop shown above in that:</p>
<ul>
<li>the <code>instance</code> loop variable is used to create the name of other files to access therein data that is relevant to the function of the script. Recall that:<br>
“<em>Each instance name is the key to access each instance results files in the</em> <code>outputs</code> <em>directory</em>”.</li>
<li><code>aws</code> is run to make the corresponding AWS operation request.</li>
<li>results and errors of invoking <code>aws</code> are saved to a file in the <code>outputs</code>/script-results/ directory.</li>
</ul>
<p>The loop in the scripts below are somewhat different to all others:</p>
<ul>
<li><strong><code>aws_domainNames_create.sh</code></strong>:<br>
<em>Before</em> invoking <code>aws</code> to create a domain name (for the <code>instance</code> being processed in the loop), <code>aws_domainNames_create.sh</code> creates a .json file with the details of the domain name to be created, and then invokes <code>aws</code> passing the path of that file as parameter, among other parameters.<br>
</li>
<li><strong><code>aws_loginKeyPair_create.sh</code></strong>:<br>
<em>After</em> invoking <code>aws</code> to create a login key (for the <code>instance</code> being processed in the loop), if the invocation was <strong>Successful</strong>, <code>aws_loginKeyPair_create.sh</code> unpacks the login key from the results file (of invoking <code>aws</code>) into a .pem file. Such results are returned in .json format, which includes a key-value pair for each item of information returned, for example: “KeyName”: “login-key-instance01”; “KeyPairId”: “key-0f2702d75934347e4”; “KeyMaterial”: ” <em>the login key itself</em> “, among other items of information. The value of”KeyMaterial” is extracted from the resuts file, and somewhat processed before writing it onto a .pem file. The processing is required for the login keys to work in MacOS machines.</li>
</ul>
</section>
</section>
</section>
<section id="the-aws-cli-command-reference" class="level1">
<h1>2. The AWS CLI Command Reference</h1>
<p>The code box below shows some of the <code>aws</code> (AWS CLI) commands used by the Scripts. For each command, only the first three parameters passed to <code>aws</code> by the Scripts are shown (the actual commands pass quite a few more parameters).</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Code</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="Code"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 create-key-pair <span class="at">--key-name</span> ..</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 delete-key-pair <span class="at">--key-name</span> ..</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 run-instances <span class="at">--image-id</span>  ..</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 terminate-instances  <span class="at">--instance-ids</span> ..</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 allocate-address <span class="at">--domain</span> ..</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 release-address <span class="at">--allocation-id</span> ..</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> route53 change-resource-record-sets <span class="at">--hosted-zone-id</span> ..</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 describe-volumes <span class="at">--filters</span> ..</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first parameter identifies the target main AWS service: <code>ec2</code> and <code>route53</code> (in the code box). The service <code>ec2</code> stands for Elastic Compute Cloud which comprises quite a few sub-services or resources such as: login keys, AMI, IP addreses, volumes, snapshots, etc. The service <code>route53</code> is the one that deals with domain names.</p>
<p>The second parameter (<code>create-key-pair</code>, .., or <code>describe-volumes</code>), is the command/operation we want the AWS service to perform. Each of the commands above has the form <em>verb-noun</em>, or <em>action-onWhat</em>, thus identifying the type of EC2 resource on which the command will be applied.</p>
<p>The third parameter, (<code>--key-name</code>, .., or <code>--filters</code>), and the following parameters are the <em>parameters to the command</em> (the second parameter of <code>aws</code>), identifying the target specific AWS resource to be affected and how it will be affected by the command requested.</p>
<p>The AWS CLI (<code>aws</code>) is extremely powerful and flexible. The Scripts only use only a minor part of it. The AWS CLI enables you to access and modify any AWS service and any type of resource within each service. There are over 100 AWS services, of which EC2 is one of them. EC2 has over 200 <em>command-resource</em> operations.</p>
<p>If you plan to improve the Scripts and this involves changing the <code>aws</code> commands in the Scripts, you need to consult the <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/index.html">AWS CLI Command Reference</a> — the landing page is shown below.</p>
<p>Overall, in trying a new <code>aws</code> command you should aim to have a simple version of the new command running as soon as possible and then tune it gradually. For this purpose, look at the relevant examples in the AWS CLI Command Reference. The screenshots below show you how to get to the Examples of the <code>aws ec2 run-instances</code> command that creates (runs and launches) instances. Our Script <code>aws_instances_launch.sh</code> uses a version of those examples.</p>
<p>On the “AWS CLI Command Reference” page, click on <strong>Available Services</strong> and scroll down until you find <strong>ec2</strong> and click on it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/01-aws-cli-cmd-ref-home-page.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI Command Reference page in a browser showing the option Available Services circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/02-aws-cli-cmd-ref-services-list-including-ec2.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI Command Reference page in a browser, scrolled down and showing the option ec2 circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
<p>The page “ec2” will be presented. Click on <strong>Available Commands</strong> and scroll down until you find <strong>run-instances</strong> and click on it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/03-aws-cli-cmd-ref-ec2-homepage.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI ec2 page in a browser, showing the option Available commands circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/04-aws-cli-cmd-ref-ec2-service-list-run-instances.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI ec2 page in a browser, scrolled down and showing the option run-instances circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
<p>The page “run-instances” will be presented. Click on <strong>Examples</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/05-aws-cli-cmd-ref-ec2-run-instances-page.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI run-instances page in a browser, showing the option Examples circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
<p>The page below will be presented. You can see the resemblance between the code in the examples below and the code in our Script <code>aws_instances_launch.sh</code>. The main difference being our use of shell variables to tune the <code>aws</code> command within the loop according to each instance name, etc.</p>
<p>We developed all the Scripts starting with the relevant examples in the AWS CLI Command Reference.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/04-the-Scripts-design/06-aws-cli-cmd-ref-ec2-run-instances-example2.png" class="img-fluid figure-img" alt="Screenshot of AWS CLI run-instances page in a browser, scrolled down and showing the headings Example 1 .. and Example 2 ..  circled" width="900"></p>
<figcaption>.</figcaption>
</figure>
</div>
</section>
<section id="improving-the-scripts" class="level1">
<h1>3. Improving the Scripts</h1>
<p>The Scripts provide enough functionality to manage well one or multiple AWS instances in the context of hands-on training and similar contexts, wherein each instance is to be used by a single person for a period of time. Other contexts will most likely need modifying the scripts and, of course, the scripts can be improved somehow. This is a list of improvements that we have identified:</p>
<ol type="1">
<li><p>Handling comments in configuration files: <code>resourcesIDs.txt</code>, <code>tags.txt</code> and “<em>instancesNames.txt</em>” files. This will make those files more readable.</p></li>
<li><p>Code naming conventions and comments in the Scripts can be improved.</p></li>
<li><p>Checking some resouces limits (quotas) of the target AWS account. For example, the Scripts use <em>elastic</em> IP addresses that don’t change on rebooting instances. The default number of elastic IPs for each AWS account is 5, and can be increased in the AWS Console. However, the Scripts will fail if the number of available IP addresses is exceeded when running the Scripts: the Scripts will fail in creating the IP addresses but would have succeded in creating the login keys and the intances. Hence, after increasing that number in the AWS Console, the Scripts <code>aws_elasticIPs_allocate.sh</code>, <code>aws_domainNames_create.sh</code>, <code>aws_elasticIPs_associate2instance.sh</code>, and <code>aws_instances_configure.sh</code> would have to be run “manually”.</p></li>
<li><p>Managing <em>dynamic</em> IP addresses (that change on rebooting instances), as opposed to <em>elastic</em> IP addresses, should perhaps be considered in order to make management more efficient and less dependant on resources limits.</p></li>
<li><p>Adding the <code>--dry-run</code> option to the Scripts would facilitate development. The AWS CLI (<code>aws</code>) supports a <code>--dry-run</code> and it would be a matter of handling that option within the Scripts.</p></li>
</ol>
<p>Congratulations! You have completed the Automated Management of AWS Instances course.</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/Cloud-SPAN\.github\.io\/cloud-admin-guide-v2q\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../docs/lesson02-managing-aws-instances/03-ami-management.html" class="pagination-link" aria-label="AMIs Management">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">AMIs Management</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2021–24 by <a href="https://cloud-span.york.ac.uk/">Cloud-SPAN</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Cloud-SPAN/nerc-metagenomics-v2q/edit/main/docs/lesson02-managing-aws-instances/04-scripts-design.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/Cloud-SPAN/nerc-metagenomics-v2q/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/SpanCloud">
      <i class="bi bi-twitter" role="img" aria-label="Quarto Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Cloud-SPAN/nerc-metagenomics-v2q">
      <i class="bi bi-github" role="img" aria-label="Quarto GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>